<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
   <mapper namespace="com.oracle.S20220601.StoreRevMapper">
	 	<!-- 식당 리뷰  -->
	  	<select id="storeRevList" parameterType="int" resultType="review">
	  		SELECT * FROM review WHERE host_num = #{host_num} ORDER BY rev_num DESC
	  	</select>
	  	<!-- 식당 리뷰 사진 -->
	  	<select id="storeRevPhoto" parameterType="Review" resultType="RevPhoto">
	  		SELECT * FROM revphoto WHERE host_num = #{host_num}
	  	</select>
	  	
	  	<!-- 식당 리뷰 삭제 -->
	  	<delete id="storeUserRevDel" parameterType="StoreReview">
	  			  		DELETE FROM review   WHERE ref      = #{rev_num} 
				  						     AND   host_num = #{host_num} 
	  	</delete>
	  	
	  	<!-- 식당 리뷰 갯수 -->
	  	<update id="storeRevcount" parameterType="int">
	  		UPDATE host SET rev_count = (SELECT COUNT(*) FROM review WHERE host_num = #{host_num} AND re_step = 0) WHERE host_num = #{host_num}
	  	</update>
	  	
	  	<!-- 식당 평점 	-->
	  	<update id="storeRevPointAvg" parameterType="int">
	  		UPDATE host SET host_avg = (SELECT (round(NVL(sum(rev_point)/COUNT(*),0),1)) FROM review WHERE host_num = #{host_num} AND re_step = 0) WHERE host_num = #{host_num}
	  	</update>
	  	
	  	<!-- 리뷰 작성  -->
	  	<insert id="storeUserRevInsert" parameterType="StoreReview">
	  		INSERT INTO review VALUES(#{host_num},SEQ_REV_NUM.nextval,#{mem_num},#{rev_content},sysdate,5,SEQ_REV_NUM.nextval,0)
	  	</insert>
	  	
	  	<!-- 리뷰 사진 등록  -->
	  	<insert id="storeRevPhotoInsert" parameterType="StoreReview">
	  		INSERT INTO revphoto VALUES(#{host_num},SEQ_REV_NUM.CURRVAL,SEQ_HOST_PHOTO_NUM.nextval,#{rev_photo})
	  	</insert>
	  	
	  	<!-- 리뷰 답변 등록  -->
	  	<insert id="hostRevInsert" parameterType="Review">
	  		INSERT INTO review VALUES(#{host_num},SEQ_REV_NUM.nextval,#{mem_num},#{rev_content},sysdate,5,#{rev_num},1)
	  	</insert>
	  	
	  	<!-- 리뷰 답변 삭제  -->
	  	<delete id="hostRevDelete" parameterType="Review">
	  			DELETE FROM review   WHERE rev_num        = #{rev_num} 
				  						   AND   host_num = #{host_num}
				  						   AND   mem_num  = #{mem_num}
	  	</delete>
   </mapper>